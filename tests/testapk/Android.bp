package {
    default_applicable_licenses: ["Android-Apache-2.0"],
}

android_test {
    name: "MicrodroidTestApp",
    test_suites: ["device-tests"],
    srcs: ["src/java/**/*.java"],
    static_libs: [
        "androidx.test.runner",
        "androidx.test.ext.junit",
        "com.android.microdroid.testservice-java",
    ],
    libs: ["android.system.virtualmachine"],
    jni_libs: ["MicrodroidTestNativeLib"],
    platform_apis: true,
    use_embedded_native_libs: true,
}

// TODO(jiyong): make this a binary, not a shared library
cc_library_shared {
    name: "MicrodroidTestNativeLib",
    srcs: ["src/native/testbinary.cpp"],
    shared_libs: [
        "android.system.keystore2-V1-ndk",
        "android.system.virtualmachineservice-ndk",
        "com.android.microdroid.testservice-ndk",
        "libbase",
        "libbinder_ndk",
        "libbinder_rpc_unstable",
        "MicrodroidTestNativeLibSub",
    ],
    static_libs: [
        "libfsverity_digests_proto_cc",
        "liblog",
        "libprotobuf-cpp-lite-ndk",
    ],
}

cc_library_shared {
    name: "MicrodroidTestNativeLibSub",
    srcs: ["src/native/testlib.cpp"],
}

genrule {
    name: "MicrodroidTestApp.signed",
    out: [
        "MicrodroidTestApp.apk",
        "MicrodroidTestApp.apk.idsig",
    ],
    srcs: [":MicrodroidTestApp"],
    tools: ["apksigner"],
    tool_files: ["test.keystore"],
    cmd: "$(location apksigner) sign " +
        "--ks $(location test.keystore) " +
        "--ks-pass=pass:testkey --key-pass=pass:testkey " +
        "--in $(in) " +
        "--out $(genDir)/MicrodroidTestApp.apk",
    // $(genDir)/MicrodroidTestApp.apk.idsig is generated implicitly
}
